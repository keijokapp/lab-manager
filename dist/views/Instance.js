"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _react=_interopRequireDefault(require("react")),_semanticUiReact=require("semantic-ui-react"),_util=require("./util");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function Assistant(a){if("object"!=typeof a.template||null===a.template)return _react.default.createElement("i",null,"None");let b,c;return"object"==typeof a.assistant&&a.assistant&&(b=_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"User key: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,a.assistant.userKey))),c=_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Link: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement("a",{href:a.assistant.link,target:"_blank"},a.assistant.link))))),"key"in a.template?_react.default.createElement("div",null,_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"URL: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,a.template.url))),_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Key: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement(_util.SecretKey,null,a.template.key)))),_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Lab ID: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,a.template.lab))),b,c):"object"==typeof a.assistant&&a.assistant&&"userKey"in a.assistant?_react.default.createElement("div",null,b,c):_react.default.createElement("i",null,"None")}class Machine extends _react.default.Component{constructor(a){super(),this.state={loading:null,machine:{...a.machine}}}openRdp(){window.open(config.remote+"/"+encodeURIComponent(window.INIT_STATE.instanceToken)+":"+encodeURIComponent(this.props.id))}setMachineState(a){this.state.loading||(this.setState({loading:a}),fetch("instance/"+encodeURIComponent(window.INIT_STATE.instanceToken)+"/machine/"+encodeURIComponent(this.props.id)+"?ip",{method:"PUT",headers:{"content-type":"application/json","if-match":this.props.rev},body:JSON.stringify({state:a})}).then(a=>a.ok?a.json().then(a=>{this.setState({machine:a,loading:null})}):void this.setState({loading:null})).catch(()=>{this.setState({loading:null})}))}reload(){this.state.loading||(this.setState({loading:"reload"}),fetch("instance/"+encodeURIComponent(window.INIT_STATE.instanceToken)+"/machine/"+encodeURIComponent(this.props.id)+"?ip",{headers:{"if-match":this.props.rev}}).then(a=>a.ok?a.json().then(a=>{this.setState({machine:a,loading:null})}):void this.setState({loading:null})).catch(()=>{this.setState({loading:null})}))}render(){const a=this.state.machine,b=this.props.template;let c;this.props.primary&&(c=_react.default.createElement(_semanticUiReact.Icon,{name:"star"}));let d;"rdp-port"in a&&(d=_react.default.createElement(_semanticUiReact.Button,{icon:!0,color:"blue",basic:!0,onClick:()=>this.openRdp()},"RDP: ",a["rdp-port"]," ",_react.default.createElement(_semanticUiReact.Icon,{name:"external alternate"})));let e;"networks"in a&&(e=a.networks.map((a,b)=>_react.default.createElement("div",{key:b},a.name)));let f="poweroff"===a.state||"stopped"===a.state?_react.default.createElement(_semanticUiReact.Button,{icon:!0,primary:!0,disabled:!!this.state.loading,loading:"running"===this.state.loading,onClick:()=>this.setMachineState("running")},_react.default.createElement(_semanticUiReact.Icon,{name:"bolt"})," Power on"):"running"===a.state?"virtualbox"===this.props.template.type?_react.default.createElement(_semanticUiReact.Button.Group,null,_react.default.createElement(_semanticUiReact.Button,{icon:!0,color:"yellow",disabled:!!this.state.loading,loading:"acpipowerbutton"===this.state.loading,onClick:()=>this.setMachineState("acpipowerbutton")},_react.default.createElement(_semanticUiReact.Icon,{name:"power off"})," Shutdown"),_react.default.createElement(_semanticUiReact.Button.Or,null),_react.default.createElement(_semanticUiReact.Button,{icon:!0,negative:!0,disabled:!!this.state.loading,loading:"poweroff"===this.state.loading,onClick:()=>this.setMachineState("poweroff")},_react.default.createElement(_semanticUiReact.Icon,{name:"plug"})," Power off")):_react.default.createElement(_semanticUiReact.Button.Group,null,_react.default.createElement(_semanticUiReact.Button,{icon:!0,negative:!0,disabled:!!this.state.loading,loading:"poweroff"===this.state.loading,onClick:()=>this.setMachineState("poweroff")},_react.default.createElement(_semanticUiReact.Icon,{name:"plug"})," Power off")):_react.default.createElement(_semanticUiReact.Button,{disabled:!0},"Unknown");const g=[];if("ip"in a)for(const b in a.ip)if(4<=g.length){g.push(_react.default.createElement("p",{key:b},"..."));break}else g.push(_react.default.createElement("p",{key:b},a.ip[b]));const h=_react.default.createElement(_semanticUiReact.Button,{icon:!0,loading:"reload"===this.state.loading,disabled:!!this.state.loading,onClick:()=>this.reload()},_react.default.createElement(_semanticUiReact.Icon,{name:"sync alternate"}));return _react.default.createElement(_semanticUiReact.Table.Row,null,_react.default.createElement(_semanticUiReact.Table.Cell,{collapsing:!0},c),_react.default.createElement(_semanticUiReact.Table.Cell,null,b.description),_react.default.createElement(_semanticUiReact.Table.Cell,null,a.name),_react.default.createElement(_semanticUiReact.Table.Cell,null,b.base),_react.default.createElement(_semanticUiReact.Table.Cell,null,e),_react.default.createElement(_semanticUiReact.Table.Cell,null,g),_react.default.createElement(_semanticUiReact.Table.Cell,{collapsing:!0},d),_react.default.createElement(_semanticUiReact.Table.Cell,{collapsing:!0,style:{textAlign:"right"}},f),_react.default.createElement(_semanticUiReact.Table.Cell,{collapsing:!0},h))}}function Machines(a){if(!a.machineOrder||0===a.machineOrder.length)return _react.default.createElement("i",null,"None");const b=a.machineOrder.map(b=>_react.default.createElement(Machine,{key:b,id:b,rev:a.rev,machine:a.machines[b],template:a.templates[b],primary:a.primary===b}));return _react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Table,{selectable:!0},_react.default.createElement(_semanticUiReact.Table.Header,null,_react.default.createElement(_semanticUiReact.Table.Row,null,_react.default.createElement(_semanticUiReact.Table.HeaderCell,{collapsing:!0}),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Description"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Name"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Base template"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,{width:3},"Networks"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"IP-s"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null))),_react.default.createElement(_semanticUiReact.Table.Body,null,b)))}function Repositories(a){const b=[];for(const c in a.template)b.push(_react.default.createElement(_semanticUiReact.Table.Row,{key:c},_react.default.createElement(_semanticUiReact.Table.Cell,null,c),_react.default.createElement(_semanticUiReact.Table.Cell,null,a.template[c].name),_react.default.createElement(_semanticUiReact.Table.Cell,null,a.template[c].head),_react.default.createElement(_semanticUiReact.Table.Cell,null,a.repositories[c].link)));return 0===b.length?_react.default.createElement("i",null,"None"):_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Table,null,_react.default.createElement(_semanticUiReact.Table.Header,null,_react.default.createElement(_semanticUiReact.Table.Row,null,_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"ID"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Repository"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Head"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Link"))),_react.default.createElement(_semanticUiReact.Table.Body,null,b)))}function Endpoints(a){function b(b){const c=a.endpoints[b].link;if(c.startsWith("http:")||c.startsWith("https:"))return _react.default.createElement("a",{href:c,target:"_blank"},c);if(c.startsWith("ssh:"))try{const[a,b]=c.slice(6).split(":");return"ssh "+a+" -p"+b}catch(a){return c}else return c}if(!Array.isArray(a.names))return _react.default.createElement("i",null,"None");const c=a.names.map(c=>_react.default.createElement(_semanticUiReact.Table.Row,{key:c},_react.default.createElement(_semanticUiReact.Table.Cell,null,c),_react.default.createElement(_semanticUiReact.Table.Cell,null,a.endpoints[c].key),_react.default.createElement(_semanticUiReact.Table.Cell,null,b(c))));return _react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Table,null,_react.default.createElement(_semanticUiReact.Table.Header,null,_react.default.createElement(_semanticUiReact.Table.Row,null,_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Name"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Key"),_react.default.createElement(_semanticUiReact.Table.HeaderCell,null,"Link"))),_react.default.createElement(_semanticUiReact.Table.Body,null,c)))}function Gitlab(a){if("object"!=typeof a.template||null===a.template)return _react.default.createElement("i",null,"None");let b,c;"object"==typeof a.gitlab&&null!==a.gitlab&&(b=_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Group link: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement("a",{target:"_blank",href:a.gitlab.group.link},a.gitlab.group.link)))),c=_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"User link: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement("a",{target:"_blank",href:a.gitlab.user.link},a.gitlab.user.link)))));let d;return"key"in a.template&&(d=_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Key: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement(_util.SecretKey,null,a.template.key))))),_react.default.createElement("div",null,_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"URL: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement("a",{href:a.template.url,target:"_blank"},a.template.url)))),d,b,c)}function Timing(a){function b(a,c,d=[]){if(Array.isArray(a))c(d,a);else for(const e in a)b(a[e],c,[...d,e])}const c=new Date(a.startTime).getTime();let d=c;b(a.timing,(a,b)=>{b[1]>d&&(d=b[1])}),d-=c;let e=[];return b(a.timing,(a,b)=>{e.push(_react.default.createElement(_semanticUiReact.Table.Row,{key:a.join(": ")},_react.default.createElement(_semanticUiReact.Table.Cell,{style:{fontWeight:"body"}},a.join(": ")),_react.default.createElement(_semanticUiReact.Table.Cell,null,_react.default.createElement("span",{style:{display:"inline-block",width:80*((b[0]-c)/d)+"%"}},b[0]-c),_react.default.createElement("span",{style:{display:"inline-block",width:80*((b[1]-b[0])/d)+"%",backgroundColor:"lightgreen"}},b[1]-b[0]))))}),_react.default.createElement(_semanticUiReact.Table,{compact:!0},e)}class _default extends _react.default.Component{constructor(){super(),this.state={loading:null}}deleteInstance(){this.state.loading||(this.setState({loading:"delete"}),fetch("lab/"+encodeURIComponent(this.props.instance.lab._id)+"/instance/"+encodeURIComponent(this.props.instance.username),{method:"DELETE",headers:{"if-match":this.props.instance._rev}}).then(a=>{a.ok?window.location.href="instance":this.setState({loading:null})}).catch(()=>{this.setState({loading:null})}))}render(){const a=this.props.instance,b=a.lab,c=new Date(a.startTime),d=_react.default.createElement(Assistant,{assistant:a.assistant,template:b.assistant}),e=_react.default.createElement(Machines,{machines:a.machines,templates:b.machines,machineOrder:b.machineOrder,primary:b.primaryMachine,rev:a._rev}),f=_react.default.createElement(Repositories,{repositories:a.repositories,template:b.repositories}),g=_react.default.createElement(Endpoints,{endpoints:a.endpoints,names:b.endpoints}),h=_react.default.createElement(Gitlab,{gitlab:a.gitlab,template:b.gitlab,publicToken:a.publicToken});let i;return"_id"in a&&(i=_react.default.createElement(_semanticUiReact.Popup,{on:"click",position:"top center",wide:!0,hideOnScroll:!0,trigger:_react.default.createElement(_semanticUiReact.Button,{negative:!0,disabled:!!this.state.loading,loading:"delete"===this.state.loading,icon:!0},_react.default.createElement(_semanticUiReact.Icon,{name:"trash"})," Delete")},_react.default.createElement(_semanticUiReact.Button,{negative:!0,onClick:()=>this.deleteInstance()},"Confirm deletion"))),_react.default.createElement(_semanticUiReact.Grid,null,_react.default.createElement(_semanticUiReact.Grid.Column,null,_react.default.createElement(_semanticUiReact.Header,{color:"teal",size:"huge"},"Instance"),a.imported&&_react.default.createElement(_semanticUiReact.Header,{color:"blue",size:"medium"},"Imported"),_react.default.createElement(_semanticUiReact.Segment,null,b._id&&_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Lab: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement("a",{href:"lab/"+encodeURIComponent(b._id)},b._id)))),a.username&&_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Username: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,a.username))),_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Start time: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,c.toDateString()+" "+c.toTimeString().split(" ")[0]," (",_react.default.createElement(_util.TimeSince,{date:c}),")"))),_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Public token: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement("a",{href:"instance/"+encodeURIComponent(a.publicToken)},a.publicToken)))),a.privateToken&&_react.default.createElement("div",null,_react.default.createElement(_semanticUiReact.Label,{size:"big"},"Private token: ",_react.default.createElement(_semanticUiReact.Label.Detail,null,_react.default.createElement(_util.SecretKey,{as:"a",href:"instance/"+encodeURIComponent(a.privateToken)},a.privateToken))))),_react.default.createElement(_semanticUiReact.Segment,null,_react.default.createElement(_semanticUiReact.Header,null,"Assistant"),d),_react.default.createElement(_semanticUiReact.Segment,null,_react.default.createElement(_semanticUiReact.Header,null,"Machines"),e),_react.default.createElement(_semanticUiReact.Segment,null,_react.default.createElement(_semanticUiReact.Header,null,"Repositories"),f),_react.default.createElement(_semanticUiReact.Segment,null,_react.default.createElement(_semanticUiReact.Header,null,"Endpoints"),g),_react.default.createElement(_semanticUiReact.Segment,null,_react.default.createElement(_semanticUiReact.Header,null,"Gitlab"),h),_react.default.createElement(_semanticUiReact.Segment,null,_react.default.createElement(_semanticUiReact.Header,null,"Timing"),_react.default.createElement(Timing,{startTime:a.startTime,timing:a.timing})),i))}}exports.default=_default;